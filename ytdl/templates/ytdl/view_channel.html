{% extends "base.html" %}
{% block head %}
<link href="/static/css/pop.css" media="all" rel="stylesheet" type="text/css"/>
<script language="javascript" src="/static/js/jquery.pop.js" type="text/javascript"></script>
<script language="javascript" src="/static/js/jquery.timeago.js" type="text/javascript"></script>
{% endblock %}

{% block content %}

{% include "ytdl/navbar.html" %}

<div class="pagination">
    <span class="step-links">
        <span class="current">
            Page {{ videos.number }} of {{ videos.paginator.num_pages }}.
        </span>

        <br>
        {% if videos.has_next %}
            <a href="?page={{ videos.next_page_number }}&search={{query}}">Next.</a>
        {% endif %}

        <br>
        {% if videos.has_previous %}
            <a href="?page={{ videos.previous_page_number }}&search={{query}}">Previous.</a>
        {% endif %}

        <br>
    </span>
</div>

<table class="table table-striped table-hover table-condensed" id="videos">
  <thead>
    <th>Actions</th>
    <th>Title</th>
    <th width="75px">Status</th>
    <th width="100px">Released</th>
  </thead>

  {% for v in videos %}
  <tr class="{{ v.status_class }}">
    <td>
      <a href="{% url ytdl.views.grab v.id %}" class="async"><i class="icon-download-alt"></i></a>
      <a href="{% url ytdl.views.mark_viewed v.id %}" class="async"><i class="icon-ok" title="Mark as viewed"></i></a>
      <a href="{% url ytdl.views.mark_ignored v.id %}" class="async"><i class="icon-minus" title="Mark video as ignored"></i></a>
    </td>
    <td>
      {% if not channel %}
        <img width="12px" src="{% url ytdl.views.channel_icon v.channel.chanid %}">
      {% endif %}
      <a href="{{ v.url }}">{{ v.title }} {% if not channel %}<small style="color:grey"> [{{ v.channel.chanid }}]{% endif %}</small></a>

      <div class="pop" style="display:none">
        <p>
          {% for img in v.img %}
          <img src="/static/img/blank.gif" width="64" data-original="{{ img }}">
          {% endfor %}
        </p>

        {{ v.description|linebreaks }}
      </div> 
    </td>
    <td>
      {{ v.status_str}}
    </td>
    <td>
      <abbr style="font-size:0.7em" class="timeago" title="{{ v.publishdate|date:'c' }}">{{ v.publishdate }}</abbr>
    </td>

    {% endfor %}
</table>

<p>
  {% if channel %}
  <a href="{% url ytdl.views.refresh_channel channel.id %}" class="async"><i class="icon-refresh"></i>Refresh {{channel.chanid}}</a>
  {% else %}
  <a href="{% url ytdl.views.refresh_all %}" class="async"><i class="icon-refresh"></i>Refresh all</a>
  {% endif %}
</p>
<script type="text/javascript">
  $(function(){
  
    <!-- Popup for descriptions -->
    $(function(){
      $.pop();
    });

    <!-- Download links -->
    $("a.async").each(function(i, ahref){
      $(ahref).click(function(evt){
        $(ahref).parent().parent().removeClass();
        $.ajax(ahref.href)
          .done(function(data, textStatus, jqXHR){
            <!-- Indicate something happened -->
            <!-- FIXME: This does not update status column, incorrect colours when marking as read etc. Awful. -->
            $(ahref).parent().parent().addClass("pending");})
          .fail(function(jqXHR, textStatus, errorThrown){
            <!-- Request failed (e.g already downloaded) -->
            $(ahref).parent().parent().addClass("error");});

        return false;
      });
    });

    <!-- Time ago -->
    $("abbr.timeago").timeago();

  });
</script>
{% endblock %}
