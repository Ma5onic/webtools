{% extends "base.html" %}
{% block head %}
<style type="text/css" media="screen">
  table tr td,
  table tfoot tr td
  {
    padding:     0.3em !important;
    line-height: 1em !important;
  }
  table tr.pending{
    background-color: rgb() !important;
  }
  table tr.info{
    background-color: rgb(145, 177, 199) !important;
  }
  table tr.success{
    background-color: rgb(200, 250, 180) !important;
  }
</style>
{% endblock %}

{% block content %}

{% include "ytdl/navbar.html" %}

<table width="100%" border="0">
  <tr>
    <td>

      <div class="pagination">
        <span class="step-links">
          <span class="current">
            Page {{ videos.number }} of {{ videos.paginator.num_pages }}.
          </span>

          <br>

          {% if videos.has_next %}
          <a href="?page={{ videos.next_page_number }}&search={{query}}">Next.</a>
          {% endif %}

          <br>
          {% if videos.has_previous %}
          <a href="?page={{ videos.previous_page_number }}&search={{query}}">Previous.</a>
          {% endif %}

          <br>
        </span>
      </div>

    </td>
    <td>
      {% if channel %}
      <h2>{{ channel.title }} <small>{{channel.chanid}} (on {{channel.service}})</small></h2>
      {% else %}
      <h2>All channels</h2>
      {% endif %}
    </td>
  </tr>
</table>

<table class="table table-striped table-hover table-condensed" id="videos">
  <thead>
    <th>Actions</th>
    <th>Title</th>
    <th width="75px">Status</th>
    <th width="160px">Released</th>
  </thead>

  {% for v in videos %}
  <tr class="{{ v.status_class }}">
    <td>
      <a href="{% url 'ytdl.views.grab' v.id %}" class="async"><i class="fa fa-download"></i></a>
      <a href="{% url 'ytdl.views.mark_viewed' v.id %}" class="async"><i class="fa fa-check" title="Mark as viewed"></i></a>
      <a href="{% url 'ytdl.views.mark_ignored' v.id %}" class="async"><i class="fa fa-square-o" title="Mark video as ignored"></i></a>
    </td>
    <td>
      {% if not channel %}
        <a href="{% url 'ytdl.views.view_channel' v.channel.id %}"><img width="12px" src="{{ v.channel.icon_url }}"></a>
      {% endif %}
      <a href="{{ v.url }}">{{ v.title }} {% if not channel %}</a>
      <a href="{% url 'ytdl.views.view_channel' v.channel.id %}"><small style="color:grey"> [{{ v.channel.title }}]{% endif %}</small></a>

      <a href="#" data-dropdown="{{ v.id }}"><i class="fa fa-info-circle"></i></a>
      <div id="{{ v.id }}" class="f-dropdown content medium" data-dropdown-content>
        <p>
          {% for img in v.img %}
          <img src="{{ img }}" width="64">
          {% endfor %}
        </p>

        {{ v.description|linebreaks }}
      </div> 

      </div>

      <div class="pop" style="display:none">
        <p>
          {% for img in v.img %}
          <img src="/static/img/blank.gif" width="64" data-original="{{ img }}">
          {% endfor %}
        </p>

        {{ v.description|linebreaks }}
      </div> 
    </td>
    <td>
      {{ v.status_str}}
    </td>
    <td>
      <abbr style="font-size:0.7em" class="timeago" title="{{ v.publishdate|date:'c' }}">{{ v.publishdate }}</abbr>
    </td>

    {% endfor %}
</table>

<p>
  {% if channel %}
  <a href="{% url 'ytdl.views.refresh_channel' channel.id %}" class="async"><i class="icon-refresh"></i>Refresh {{channel.title}}</a>
  {% else %}
  <a href="{% url 'ytdl.views.refresh_all' %}" class="async"><i class="icon-refresh"></i>Refresh all</a>
  {% endif %}
</p>

<script type="text/javascript">
  $(function(){
  
    <!-- Download links -->
    $("a.async").each(function(i, ahref){
      $(ahref).click(function(evt){
        $(ahref).parent().parent().removeClass();
        $.ajax(ahref.href)
          .done(function(data, textStatus, jqXHR){
            <!-- Indicate something happened -->
            <!-- FIXME: This does not update status column, incorrect colours when marking as read etc. Awful. -->
            $(ahref).parent().parent().addClass("pending");})
          .fail(function(jqXHR, textStatus, errorThrown){
            <!-- Request failed (e.g already downloaded) -->
            $(ahref).parent().parent().addClass("error");});

        return false;
      });
    });

    <!-- Time ago -->
    $("abbr.timeago").timeago();

  });
</script>
{% endblock %}
